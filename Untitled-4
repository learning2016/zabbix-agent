rm -rf /ftp/上传*
if grep -q send.log; then
   touch 上传ok
else
   touch 上传失败



sh auto_sendfile1_cdnftp.sh > /ftp/send.log &&sh ftp_send_status.sh


useradd -g sftp -d /ftp/ mfgen
passwd mfgen
hLTutXooz9D7H2

groupadd sftp
cat /etc/ssh/sshd_config
Match User mfgen

         ChrootDirectory /ftp/

         X11Forwarding no

         AllowTcpForwarding no

         ForceCommand internal-sftp

service sshd restart
chown root:root /ftp
chown -R mfgen:sftp /ftp/*
chmod 755 /ftp/*/*



mkdir -p /data/sftp/mfgen
chmod 0755 /data/sftp/mfgen
chown root:sftp /data/sftp/mfgen
useradd -g sftp -s /sbin/nologin mfgen


# mkdir /home/mfgen/.ssh
# ssh-keygen -t rsa
# cp /root/.ssh/id_rsa.pub /home/mfgen/.ssh/authorized_keys
# chown -R mfgen.sftp /home/mfgen


mkdir /data/sftp/mfgen/upload
chown -R mfgen:sftp /data/sftp/mfgen/upload

chown -R mfgen:sftp /data/sftp/mfgen/bj_RESLAN
chown -R mfgen:sftp /data/sftp/mfgen/bj_mi
chown -R mfgen:sftp /data/sftp/mfgen/bj_shuju



**********************
#!/bin/bash
des1=/mi/
local1=/data/sftp/mfgen/bj_mi/

rm -rf /data/sftp/mfgen/上传*
cd $local1
files=$(ls * 2> /dev/null | wc -l)
if [ "$files" != "0" ] ;
then
cd $local1
ftp -ivn<<EOF
  open 54.64.224.48
  user mfgen 3t5Gdvg4PQAnbJKhvfkGUSv
  binary
  cd $des1
  lcd $local1
  passive
  mput *
  cd $des1
  ls
  quit
EOF
fi
mv /data/sftp/mfgen/bj_mi/* /data/sftp/mfgen/bj_backup/

***************************
#!/bin/bash
rm -rf /data/sftp/mfgen/bj_mi/上传*
if grep -q OK. /data/sftp/mfgen/send.log; then
   touch /data/sftp/mfgen/bj_mi/上传ok
else
   touch /data/sftp/mfgen/bj_mi/上传失败
fi

********************************
*/10 * * * * sh /script/auto_sendfile1_cdnftp.sh > /data/sftp/mfgen/send.log &&sh /script/ftp_send1_status.sh > /dev/null 2>&1
*/10 * * * * sh /script/auto_sendfile2_cdnftp.sh > /data/sftp/mfgen/send.log &&sh /script/ftp_send2_status.sh > /dev/null 2>&1
*/10 * * * * sh /script/auto_sendfile3_cdnftp.sh > /data/sftp/mfgen/send.log &&sh /script/ftp_send3_status.sh > /dev/null 2>&1

IP |原来配置 | 目标配置 | 预计下降的成本/元.月 |
 148.153.39.154 	8核16G 4核16G	184.2
 148.153.39.155 	8核8G	        	399   退订


--
1）合同续签
2）完成zabbix脚本测试
3）健康证


PidFile=/var/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
Server=s.zabbix.brotlab.net,p1.zabbix.brotlab.net,p2.zabbix.brotlab.net,sg-proxy.zabbix.brotlab.net
ServerActive=s.zabbix.brotlab.net,p1.zabbix.brotlab.net,p2.zabbix.brotlab.net,sg-proxy.zabbix.brotlab.net
Timeout=10
Include=/etc/zabbix/zabbix_agentd.d/*.conf
Hostname=succotash-gmail-proxy_qlcou_hongkong

mpken-mysql-userlog-tencent-toronto

mysql -hlocalhost -uzabbixuser -pproxypasswd

1）游戏重要端口监控。
制作Templates

2）奇与骑士沟通，提供服务器部署mysql。
---
1）zabbix监控游戏入口信息，更新到Confluence
2）ansible playbook学习
---
手游英语奇与骑士 CDN源站 ca.magicell.cc 80
手游日语我的使命 登录 jp-cjzz-login.gztfgame.com 80
手游日语我的使命 CDN源站 mwarja-source.games.oasgames.com 80
手游英语巅峰战舰 登录 laun-oas.wanyuhudong.com 8000
手游英语巅峰战舰 支付 laun-oas.wanyuhudong.com 8002
手游英语巅峰战舰 CDN源站 mfgen-cdn-source.games.oasgames.com 80
手游大洋1欧洲 登录 login.mooeu.oasgames.com 80
手游大洋1欧洲 支付 login02.mooeu.oasgames.com 8082
大洋1和大洋2北美合用 CDN源站 source-mbe.games.oasgames.com 80
手游大洋1美服 登录 login.mooen.oasgames.com 80
手游大洋1美服 支付 login2.mooen.oasgames.com 8082
手游大洋2北美 登录 35.174.232.211 80
手游大洋2北美 支付 18.204.91.240 8002
手游大洋2日语 登录 loadbalancing.mclhpxja.mars.games 80
手游大洋2日语 支付 web2.mclhpxja.mars.games 8002
手游大洋2日语 CDN源站 cdnsource.mclhpxja.mars.games 80
手游英语超级舰队 登录 bigship-na-in.raygame1.com 80
手游坦克争霸（全球） CDN源站 cache1.surgegame.com 80
手游德语宠物小精灵 登录 107.150.117.49 80
手游战舰帝国德语 登录 login1.mcobde.oasgames.com 80
手游战舰帝国德语 CDN源站 ziyuancdn.mcobde.oasgames.com 80
手游战舰帝国英语 CDN源站 ziyuancdn.mcoben.oasgames.com 80
手游战舰帝国英语 登录 login01.mcoben.oasgames.com 80
手游战舰帝国俄语 CDN源站 ziyuancdn.mcobru.oasgames.com 80
手游战舰帝国俄语 登录 login1.mcobru.oasgames.com 80
不思议迷宫 登录-slave mgden-pay.games.oasgames.com 8050
不思议迷宫 登录-master mgden-pay.games.oasgames.com 8050
战国少女 登录 galaxy.p8.t7game.cn 21003
战国少女 登录 galaxy.p8.t7game.cn 21005
战国少女 登录 galaxy.p8.t7game.cn 21006
战国少女 登录 galaxy.p8.t7game.cn 21007
战国少女 登录 galaxy.p8.t7game.cn 21008
战国少女 登录 galaxy.p8.t7game.cn 21009
战国少女 登录 galaxy.p8.t7game.cn 21010
战国少女 源站 cdn-mdszgja.games.oasgames.com 80
手游神曲经典版葡语 登录 209.249.222.140 4040
手游神曲经典版葡语 登录 209.249.222.140 5009
手游神曲经典版葡语 源站 cdn-source-mlocpt.games.oasgames.com 80
手游神曲经典版土语 登录 mloctr.checkversion.oasgames.com 4040
手游神曲经典版土语 登录 mloctr.checkversion.oasgames.com 5009
手游神曲经典版土语 源站 cdn-source-mloctr.games.oasgames.com 80
死神 登录 mbsaen-web-usa-live.games.oasgames.com 80
霸道总裁日语 登录 mdcja-source.games.oasgames.com 80
轩辕传奇繁体 登录 128.14.227.36 7001
轩辕传奇繁体 登录 128.14.227.36 7002
轩辕传奇繁体 登录 128.14.227.36 7003
轩辕传奇繁体 登录 128.14.230.73 7001
轩辕传奇繁体 登录 128.14.230.73 7002
轩辕传奇繁体 登录 128.14.230.73 7003
轩辕传奇繁体 登录 128.14.229.248 7001
轩辕传奇繁体 登录 128.14.229.248 7002
轩辕传奇繁体 登录 128.14.229.248 7003
轩辕传奇繁体 登录 128.14.227.62 7004
轩辕传奇繁体 登录 128.14.227.62 7005
轩辕传奇繁体 登录 128.14.227.62 7006
轩辕传奇繁体 登录 128.14.230.32 7004
轩辕传奇繁体 登录 128.14.230.32 7005
轩辕传奇繁体 登录 128.14.230.32 7006
轩辕传奇繁体 登录 103.98.16.155 7004
轩辕传奇繁体 登录 103.98.16.155 7005
轩辕传奇繁体 登录 103.98.16.155 7006
异世界日语 登录 mhhja-account.games.oasgames.com 13200
异世界日语 登录 mhhja-account.games.oasgames.com 13201
异世界日语 源站 cdn-mhhja-client.games.oasgames.com 80
页游英语火影-欧洲 web naruto-en-gmt.oasgames.com 443
页游英语火影-欧洲 支付 naruto-en-gmt-midas.oasgames.com 80
页游英语火影-欧洲 登录 naruto-en-gmt-login.oasgames.com 443
页游英语火影-欧洲 源站 naruto-en-gmt-res.oasgames.com 443
页游英语火影-美东 web naruto-en-es.oasgames.com 443
页游英语火影-美东 支付 naruto-en-es-midas.oasgames.com 80
页游英语火影-美东 源站 naruto-en-es-res.oasgames.com 443
页游英语火影-美西 web naruto-en-pst.oasgames.com 443
页游英语火影-美西 支付 naruto-en-pst-midas.oasgames.com 80
页游英语火影-美西 源站 naruto-en-pst-res.oasgames.com 443
页游英语火影-美东-美西 登录 naruto-en-us-login.oasgames.com 443
页游英语火影-东南亚 web naruto-en-cst.oasgames.com 443
页游英语火影-东南亚 支付 naruto-en-cst-midas.oasgames.com 80
页游英语火影-东南亚 登录 naruto-en-cst-login.oasgames.com 443
页游英语火影-东南亚 源站 naruto-en-cst-res.oasgames.com 443
页游德语火影 web naruto-de.oasgames.com 443
页游德语火影 支付 naruto-de-midas.oasgames.com 80
页游德语火影 登录 naruto-de-login.oasgames.com 443
页游德语火影 源站 naruto-de-res.oasgames.com 443
页游法语火影 web naruto-fr.oasgames.com 443
页游法语火影 支付 naruto-fr-midas.oasgames.com 80
页游法语火影 登录 naruto-fr-login.oasgames.com 443
页游法语火影 源站 naruto-fr-res.oasgames.com 443
页游葡语火影 web naruto-pt.oasgames.com 443
页游葡语火影 支付 naruto-pt-midas.oasgames.com 80
页游葡语火影 登录 naruto-pt-login.oasgames.com 443
页游葡语火影 源站 naruto-pt-res.oasgames.com 443
页游波兰语火影 web naruto-pl.oasgames.com 443
页游波兰语火影 支付 naruto-pl-midas.oasgames.com 80
页游波兰语火影 登录 naruto-pl-login.oasgames.com 443
页游波兰语火影 源站 naruto-pl-res.oasgames.com 443
页游西语火影-欧洲 web naruto-xi-ep.oasgames.com 443
页游西语火影-欧洲 支付 naruto-xi-ep-midas.oasgames.com 80
页游西语火影-欧洲 登录 naruto-xi-ep-login.oasgames.com 443
页游西语火影-欧洲 源站 naruto-xi-ep-res.oasgames.com 443
页游西语火影-拉美 web naruto-xi-lm.oasgames.com 443
页游西语火影-拉美 支付 naruto-xi-lm-midas.oasgames.com 80
页游西语火影-拉美 登录 naruto-xi-lm-login.oasgames.com 443
页游西语火影-拉美 源站 naruto-xi-lm-res.oasgames.com 443
---


1）游戏重要端口监控。
更新监控目标信息到Confluence

2）降配
研发已确定降配时间的：
手游德语宠物小精灵 25日上午11点
手游日语我的使命 25日下午15点

研发确定不降配的：
大洋1欧服（已经不维护了，避免重启丢失数据。）
大洋1美服（已经不维护了，避免重启丢失数据。）
=====
1）降配
手游德语战舰帝国，暂定在下周一 下午15点

2）游戏重要端口监控。
更新文档到Confluence
http://jira.oasisgames.cn:8090/pages/viewpage.action?pageId=58242528

----
curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "https://m-mxycqtw.oasgames.com/"
curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "http://www.baidu.com"

awk '{print $1}' vipsac_https_access.log-20200327| grep "25/Mar/2020:03" sort | uniq -c | sort -n -k 1 -r | head -n 100

cat vipsac_https_access.log-20200327 |grep "25/Mar/2020:03" |awk '{print $1}' | sort | uniq -c | sort -n -k 1 -r | head -n 100

ths         443/tcp, 0.0.0.0:32924->80/tcp                  ecs-p_23_omdp4-panel_omdp4-panel_task-29-default-a2b2cdabcdcc9bafed01
c0a7a4e6f1fc        027999362592.dkr.ecr.us-east-1.amazonaws.com/lode78-orgrimmar:1.0.1-lode78-orgrmimmar-20190424205459

wget https://git.io/vpnsetup-centos -O vpnsetup.sh && sudo sh vpnsetup.sh
----
1）游戏降配
已完成
手游德语战舰帝国

计划操作
4月1日（本周三）英语战舰和俄语战舰
2）联络Constant,关于服务器合同到期一事。
已变更为每月续费
-----
1）游戏降配
手游坦克争霸，CP确认维持当前配置，不降配。

2）值班
2.1)早上收到报警，德语战舰帝国1台服务器磁盘报警，登录服务器排查大文件，写定时清理脚本。（CP响应不及时）
2.2)早上收到报警，联络樊欢，排查alb-ecs-omdp-apisdk elb TargetResponseTime问题。

3）游戏重要端口监控
细化报警，将所有游戏按4个区域展开监控.
*按游戏所属区域，监控脚本分别部署在4个地区的主机

  sg-proxy.zabbix.brotlab.net 新加坡（监控东南亚游戏）

  platform-zabbix-aws-tokyo 东京（监控日韩游戏）

  s.zabbix.brotlab.net 法兰克福（监控欧洲游戏）

  p1.zabbix.brotlab.net 弗吉尼亚（监控美洲游戏）
-----
./acli.sh --server http://jira.mars-era.cn/

-a getServerInfo --server %base_url% --user "admin" --password "m_J$j/m~[T/<W*}2iFy("
acli bobswift -a getProjectList --category CLI --outputType table --columns "1,3,5,project url,jira url" --options tableNoWrap



AAABFw0ODAoPeNptkFFrgzAQx9/zKQJ7tmjaWiYEVlRGh9ZR3Z72cstOm6LRJbGs335paxlsewiE3
O/+v7vcVfuRJigoC6k/j9g8WsxpXFaU+cE92Y7dO+qifjGoDfcCkqARWg5W9ornYIxrbdEirXtNn
za79VtE0yO0I5wJEmu8XBKwyM+BXsA8FpK4VxaE3UKHvIH+sz08NB3Idib6jnyM9UHMXFkekVs94
g1Pc4f85X98V7qVApXBVzfx+Y0R16YsKlAC069B6tM0DvM9P/DYcjKig/SgpZmshW5ASXNNLh5Jm
W65O14WLFbLlR/6JLua/g+ditVpwMuecZHn6S7erLPJV1rQzshraA2S51GLPRj8/VXfgzOKMDAsA
hQqcJ+iZKR9fuTViWNmEU+R3CUsKAIUa5KFgwHBaapBRXC/k2dYr4h5FwU=X02e6


--action runFromIssueList --jql "project = OPM order by key desc" --common "--action deleteIssue --issue @issue@"



--action deleteProject  --project  ""  --continue

SELECT DISTINCT i.PROJECT, MIN(i.UPDATED) as "Last Updated", p.pname
FROM jiraissue i
INNER JOIN project p
ON p.ID = i.PROJECT
GROUP BY i.PROJECT, p.pname
ORDER BY MIN(i.UPDATED) ASC, i.PROJECT, p.pname


--action run -u admin -p m_J$j/m~[T/<W*}2iFy( --server http://jira.mars-era.cn:8080

--action deleteProject  --project  "航站，推广页，Addon前端开发" --continue
--action deleteProject  --project  "翻译平台" --continue
-----
计划
需求背景：有个游戏项目在softlayer达拉斯机房有一批机器，间隔几个月就会有单台服务器出现磁盘不能写入的问题，而服务器本身的进程端口，没有down，多次联系机房，采用的解决方式是重启服务器，并无其他的解决方法。
尝试联系过游戏的合作方，迁移机房重新部署，无奈对方没有排期，暂时的方法，就是在没有迁移的情况下，发现问题，并尽快解决。
思路：查看dmesg，查找grep是否有报错'error count since last fsck'，没有则打印1，有则打印0，通过zabbix agent执行脚本，并传输给zabbix server。
实现：
[root@localhost script]# cat check_disk_error.sh 
#!/bin/bash
#authon:qinliang
#date:4/2/2020
tail /var/log/dmesg |grep "error count since last fsck" >/dev/null
if [ $? -eq 0 ]; then
    echo "0"
else
    echo "1"
fi
----
[root@localhost zabbix_agentd.d]# cat check_disk_error.conf 
UserParameter=check.disk.error[*],bash /etc/zabbix/script/check_disk_error.sh
--
1）值班
我认为可以继续优化晚上值班TargetResponseTime报警。
方案1，从紧急电话通知调整为钉钉消息通知，不必要把值班运维电话叫起，白天协同开发一起排查即可。
方案2，持续优化阈值，只监控重点项目的TargetResponseTime报警。

理由：
1.1）值班4天遇到的TargetResponseTime报警，都没影响游戏在线。
1.2）TargetResponseTime报警，只是一个延迟报警，没有其他意义。
1.3）进入紧急电话报警的指标应该是出错率，比如：
ELB：sum（HTTPCode_Backend_5XX），sum（HTTPCode_ELB_5XX）和sum（BackendConnectionErrors）
ALB：sum（HTTPCode_Backend_5XX），sum（HTTPCode_ELB_5XX）和sum（TargetConnectionErrorCount）

2）游戏支持
坦克争霸
写磁盘错误报警脚本，进行测试。
---
{Game Template Port Discovery clone:net.tcp.port[{#SOCKETIP},{#SOCKETPORT}].count(#20,0,eq)}>1



1）创建文件check_disk_error.sh 和check_disk_error.conf
[root@localhost script]# pwd
/etc/zabbix/script
[root@localhost script]# cat check_disk_error.sh 
#!/bin/bash
#authon:qinliang
#date:4/2/2020
tail /var/log/dmesg |grep "error count since last fsck" >/dev/null
if [ $? -eq 0 ]; then
    echo "0"
else
    echo "1"
fi

[root@localhost zabbix_agentd.d]# pwd
/etc/zabbix/zabbix_agentd.d
[root@localhost zabbix_agentd.d]# cat check_disk_error.conf 
UserParameter=check.disk.error[*],bash /etc/zabbix/script/check_disk_error.sh

2）重启zabbix agent

---
1）游戏支持
手游坦克争霸
将写好的检测磁盘读写的zabbix脚本交给CP运维部署完成

--
一、账单
已完成Ucloud


--
值班报警梳理

电话报警（紧急处理）
服务器icmp不通
服务器端口不通
服务器带宽出入超500M
服务器磁盘空闲不足10%或者20%
服务器CPU空闲不足10%
游戏入口网页非200
aws的各种监控（重点业务）

zabbix报警
aws的各种监控（非重点业务，上班时间排查，以及通知到研发）
---

docker run -d --name gitlab -p 1443:443 -p 9800:80 --restart always \
    -v /opt/gitlab/config:/etc/gitlab \
    -v /opt/gitlab/data:/var/opt/gitlab \
    -v /opt/gitlab/logs:/var/log/gitlab \
    --privileged=true \
    gitlab/gitlab-ce:latest
---
一、学习
研究github action功能（ci/cd）